# PATH configuration
export PATH=$HOME/bin:$HOME/.local/bin:/usr/local/bin:$PATH
export PATH=$PATH:$HOME/.cargo/bin
export PATH="$HOME/Installations/Webstorm/bin:$PATH"
export PATH="/usr/local/opt/postgresql@16/bin:$PATH"
export PATH="$HOME/.config/rofi/scripts:$PATH"
export PATH="$HOME/scripts:$PATH"

# Oh My Zsh configuration
export ZSH="/usr/share/oh-my-zsh"

# Shell options
DISABLE_MAGIC_FUNCTIONS="true"
ENABLE_CORRECTION="false"
COMPLETION_WAITING_DOTS="true"

# History settings
HISTSIZE=10000
SAVEHIST=10000
HISTFILE=~/.zsh_history
setopt SHARE_HISTORY          # Share history between sessions
setopt HIST_IGNORE_DUPS       # Don't save duplicate commands
setopt HIST_IGNORE_SPACE      # Ignore commands starting with space
setopt HIST_REDUCE_BLANKS     # Remove extra blanks
setopt HIST_VERIFY            # Show command before executing from history

# Custom less colors for man pages
export LESS_TERMCAP_md="$(tput bold 2> /dev/null; tput setaf 2 2> /dev/null)"
export LESS_TERMCAP_me="$(tput sgr0 2> /dev/null)"

# Plugins
plugins=(git zoxide fzf zsh-autosuggestions zsh-completions)

# Before sourcing oh-my-zsh, this prevents compinit from being called twice and significantly improves shell startup time.
fpath+=${ZSH_CUSTOM:-${ZSH:-~/.oh-my-zsh}/custom}/plugins/zsh-completions/src
autoload -U compinit && compinit

source $ZSH/oh-my-zsh.sh

# Editor configuration
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
fi
export VISUAL=nvim

# Additional plugins (Arch Linux paths)
source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
source /usr/share/zsh/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh
source /usr/share/doc/pkgfile/command-not-found.zsh

# Personal aliases
alias zq="cd ~/Code/quicargo/quicargo-platform"
alias zs="cd ~/Code/shipix/shipix-platform"
alias migrate="npm install && npm run db:migration:run"
alias ggpush='[ "$(git_current_branch)" != "main" ] && git push origin "$(git_current_branch)"'
alias i3cc='grep "^bind" ~/.config/i3/config | cut -d " " -f 2- | column | less'
alias icat='kitten icat'
alias cat='bat'
alias ls='eza'
alias ncdu='ncdu -t8'
alias lg='lazygit'
alias zsl='cd ~/Code/shipix/shipix-platform && lg'
alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n2|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"; alert'
alias onedisplay='xrandr --output DP-2 --off'
alias sdb='cd ~/Code/shipix/shipix-platform && npm run docker:database:up'
alias sapi='cd ~/Code/shipix/shipix-platform && npm run start:api:dev'
alias sapp='cd ~/Code/shipix/shipix-platform && npm run start:app:dev'
alias difft='nvim -d ~/Code/shipix/shipix-platform/apps/shipix-app/locales/en.json ~/Code/shipix/shipix-platform/apps/shipix-app/locales/nl.json'
alias kdiff='kitten diff'
alias ndiff='nvim -d'
alias dev="tmux new -A -s 0"
alias qna="claude -p"
alias sk='screenkey -s small -M -p fixed -g '
alias zz='z -'
alias vim='nvim'
alias zsn='zs && n'

# Pacman aliases (Arch Linux)
alias rmpkg="sudo pacman -Rsn"
alias cleanch="sudo pacman -Scc"
alias fixpacman="sudo rm /var/lib/pacman/db.lck"
alias update="sudo pacman -Syu"
alias apt="man pacman"
alias apt-get="man pacman"
alias please="sudo"
alias tb="nc termbin.com 9999"
alias cleanup="sudo pacman -Rsn \$(pacman -Qtdq)"
alias jctl="journalctl -p 3 -xb"
alias rip="expac --timefmt='%Y-%m-%d %T' '%l\t%n %v' | sort | tail -200 | nl"
alias yay="paru"

# Functions
function n() {
	nvim .
}

function gotest() {
  set -o xtrace
  git fetch origin $1:$1
  git checkout $1
}

function export_stash() {
  set -o xtrace
  git stash show stash@{$1} -p > patch_$1
}

function import_stash() {
  set -o xtrace
  git apply $1
}

cheatsh() {
  curl cheat.sh/"$1"
}

mkcd() {
  mkdir -p "$1" && cd "$1"
}

extract() {
  case "$1" in
    *.tar.gz|*.tgz)    tar xzf "$1" ;;
    *.tar.bz2|*.tbz2)  tar xjf "$1" ;;
    *.tar.xz|*.txz)    tar xJf "$1" ;;
    *.tar)             tar xf "$1" ;;
    *.zip)             unzip "$1" ;;
    *.7z)              7z x "$1" ;;
    *.rar)             unrar x "$1" ;;
    *.gz)              gunzip "$1" ;;
    *.bz2)             bunzip2 "$1" ;;
    *.xz)              unxz "$1" ;;
    *)                 echo "Unknown format: $1" ;;
  esac
}

source $HOME/scripts/news.sh

# export NVM_DIR="$HOME/.nvm"
# source /usr/share/nvm/init-nvm.sh
# Node version manager (lazy-loaded for faster shell startup)
# _load_nvm() {
#   unset -f nvm node npm npx
#   source /usr/share/nvm/init-nvm.sh
# }
# nvm() { _load_nvm && nvm "$@"; }
# node() { _load_nvm && node "$@"; }
# npm() { _load_nvm && npm "$@"; }
# npx() { _load_nvm && npx "$@"; }

# Vim keybindings
bindkey -v
export KEYTIMEOUT=1

# History navigation with arrow keys
bindkey "\e[A" history-beginning-search-backward
bindkey "\e[B" history-beginning-search-forward

# Vi text-objects for brackets and quotes
autoload -Uz select-bracketed select-quoted
zle -N select-quoted
zle -N select-bracketed
for km in viopp visual; do
  bindkey -M $km -- '-' vi-up-line-or-history
  for c in {a,i}${(s..)^:-\'\"\'\`\|,./:;=+@}; do
    bindkey -M $km $c select-quoted
  done
  for c in {a,i}${(s..)^:-'()[]{}<>bB'}; do
    bindkey -M $km $c select-bracketed
  done
done

# Vim-surround emulation
autoload -Uz surround
zle -N delete-surround surround
zle -N add-surround surround
zle -N change-surround surround
bindkey -M vicmd cs change-surround
bindkey -M vicmd ds delete-surround
bindkey -M vicmd ys add-surround
bindkey -M visual S add-surround

# Shell options
setopt autocd             # cd by typing directory name
setopt AUTO_PUSHD         # Push dirs to stack (use 'dirs -v', 'cd -2')
setopt PUSHD_IGNORE_DUPS  # No duplicates in dir stack
setopt NO_BEEP            # Disable beep
setopt EXTENDED_GLOB      # Extended globbing (#, ~, ^)

# Edit command line with vim (CTRL-v in vicmd mode)
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey -M vicmd '^v' edit-command-line

# Batman (bat-powered man pages)
eval "$(batman --export-env)"

# Starship prompt
eval "$(starship init zsh)"

# Change to default work directory if set
if [[ -n "$DEFAULT_WORK_DIR" && "$PWD" == "$HOME" ]]; then
    cd "$DEFAULT_WORK_DIR"
fi

# pnpm
export PNPM_HOME="/home/kricheldorf/.local/share/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end
